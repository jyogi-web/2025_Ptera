# Cloud Run デプロイ手順書

このドキュメントでは、バックエンド（Go）を Google Cloud Run にデプロイし、フロントエンド（Next.js）と接続するための手順を一から解説します。

## 1. 前提条件

* **Google Cloud アカウント**: Google Cloud Platform (GCP) のアカウントを持っていること。
* **gcloud CLI**: Google Cloud SDK がインストールされ、`gcloud` コマンドが使えること。
* **Git**: ソースコードの管理に使用。

## 2. Google Cloud プロジェクトの準備

### 2.1 プロジェクトの確認・設定

デプロイ先のプロジェクトIDを確認します（例: `ptera-481818`）。

```bash
# プロジェクト一覧を表示
gcloud projects list

# デプロイ先のプロジェクトIDを設定
gcloud config set project [PROJECT_ID]
```

### 2.2 課金 (Billing) の有効化

**重要**: Cloud Run や Cloud Build を使用するには、無料枠の範囲内であっても**請求先アカウントの紐付け（課金の有効化）が必須**です。

1. [Google Cloud Console のお支払い設定](https://console.cloud.google.com/billing) にアクセスします。
2. 対象のプロジェクトを選択し、請求先アカウントをリンクします。

### 2.3 必要な権限の付与 (IAM)

デプロイを実行するユーザー（あなたのアカウント）には、以下の強い権限が必要です。
`deploy.sh` の実行時に権限エラーが出る場合は、以下のコマンドで権限を付与してください。
※ `[PROJECT_ID]` と `[YOUR_EMAIL]` は適切な値に置き換えてください。

```bash
# Cloud Build 編集者
gcloud projects add-iam-policy-binding [PROJECT_ID] --member="user:[YOUR_EMAIL]" --role="roles/cloudbuild.builds.editor"

# Cloud Run 管理者
gcloud projects add-iam-policy-binding [PROJECT_ID] --member="user:[YOUR_EMAIL]" --role="roles/run.admin"

# Storage 管理者 (ビルドアーティファクト用)
gcloud projects add-iam-policy-binding [PROJECT_ID] --member="user:[YOUR_EMAIL]" --role="roles/storage.admin"

# サービスアカウントユーザー (Cloud Run サービスエージェントとしてデプロイするため)
gcloud projects add-iam-policy-binding [PROJECT_ID] --member="user:[YOUR_EMAIL]" --role="roles/iam.serviceAccountUser"
```

## 3. アプリケーション設定

### 3.1 環境変数の準備 (`backend/.env.local`)

バックエンドディレクトリに `.env.local` を作成し、必要な環境変数（Gemini APIキーなど）を設定します。

```bash
# backend/.env.local
GEMINI_API_KEY="your_api_key_here"
FIREBASE_SERVICE_ACCOUNT_KEY='{"type":"service_account","project_id":"your-project",...}'
```

※ このファイルは **Git管理外** (`.gitignore`) に設定し、リポジトリにコミットしないでください。

### 3.2 Cloud Run 用のポート設定 (`main.go`)

Cloud Run は環境変数 `PORT` で指定されたポートをリッスンする必要があります。
`backend/cmd/server/main.go` が以下のようになっていることを確認してください。

```go
port := os.Getenv("PORT")
if port == "" {
    port = fmt.Sprintf("%d", defaultPort)
}
lis, err := net.Listen("tcp", fmt.Sprintf(":%s", port))
```

### 3.3 ビルド除外設定 (`.dockerignore`)

ビルド時間を短縮し、不要なファイル（ローカルの設定やGitフォルダなど）を含めないために `backend/.dockerignore` を用意します。

```text
.git
.env.local
tmp
deploy.sh
```

## 4. デプロイの実行

自動デプロイスクリプト `backend/deploy.sh` を使用します。

### 4.1 スクリプトの内容確認

スクリプト内で、プロジェクトID (`PROJECT_ID`) が正しいか確認してください。

### 4.2 実行

```bash
cd backend
chmod +x deploy.sh
./deploy.sh
```

このスクリプトは以下の処理を自動で行います：

1. 必要な API の有効化 (Cloud Build, Cloud Run 等)
2. Cloud Build によるコンテナイメージのビルド
3. Cloud Run へのサービスデプロイ（`.env.local` の値を環境変数として注入）

成功すると、最後にデプロイされたサービスの URL が表示されます。
例: `https://ptera-backend-177676443844.asia-northeast1.run.app`

## 5. フロントエンドの接続設定

デプロイされたバックエンドに接続するため、フロントエンドの設定を更新します。

### 5.1 環境変数の更新 (`front/.env.local`)

`front/.env.local` に `BACKEND_URL` を追加します。

```bash
# front/.env.local
# ... 既存の設定 ...
BACKEND_URL="https://[YOUR_CLOUD_RUN_URL]"
```

### 5.2 動作確認

設定変更後、フロントエンドの開発サーバーを再起動します。

```bash
# frontディレクトリで
npm run dev
```

これで、ローカルのフロントエンドから Cloud Run 上のバックエンドへリクエストが送信されるようになります。

## 6. デプロイ時の重要ポイント・トラブルシューティング

今回の構築で判明した、特に注意すべきフラグや設定についてまとめました。

### 6.1 gRPC サーバーには `--use-http2` が必須

Cloud Run で gRPC を動作させる場合、HTTP/2 を明示的に有効にする必要があります。これがないと、クライアントからの接続が確立できません。
`gcloud run deploy` コマンドには必ず `--use-http2` を付けてください。

### 6.2 JSON形式の環境変数の扱い (`--env-vars-file`)

`FIREBASE_SERVICE_ACCOUNT_KEY` のような JSON 文字列を環境変数として渡す場合、`--set-env-vars` フラグで直接指定すると、値に含まれる「カンマ (`,`)」が区切り文字として誤認され、構文エラー (`Bad syntax for dict arg`) になります。

**解決策:** 環境変数を YAML ファイルに書き出し、`--env-vars-file` で読み込ませる方法が最も安全です。

**推奨されるデプロイスクリプトのパターン:**

```bash
# 1. 一時的なYAMLファイルを生成（値はシングルクォートで囲む）
cat <<EOF > env_vars.yaml
FIREBASE_SERVICE_ACCOUNT_KEY: '${FIREBASE_SERVICE_ACCOUNT_KEY}'
...
EOF

# 2. ファイル指定でデプロイ
gcloud run deploy ... --env-vars-file env_vars.yaml

# 3. 掃除
rm env_vars.yaml
```

### 6.3 プロジェクトを跨ぐ Firestore アクセス

Compute Engine や Cloud Run のデフォルトサービスアカウントは、**同一プロジェクト内**のリソースにはアクセスしやすいですが、**別プロジェクト**（今回は `putera2`）の Firestore にアクセスする場合は権限が不足します。
そのため、`FIREBASE_SERVICE_ACCOUNT_KEY` を明示的に環境変数として渡し、アプリケーション内で `option.WithCredentialsJSON` などを使ってクライアントを初期化する必要があります。

### 6.4 `.env.local` のフォーマット

シェルスクリプトで `source .env.local` して変数を読み込む場合、値にスペースや改行が含まれているとエラーになります。
特に JSON キーなどは、必ず**シングルクォート (`'`)** で囲んで定義してください。

```bash
# OK
KEY='{"foo": "bar"}'

# NG (パースエラー)
KEY={"foo": "bar"}
```
